<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Web RPG</title>
  <style>
    body {
      margin: 0;
      background: #222;
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      user-select: none;
    }

    /* Gold表示 */
    #gold { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 24px; }
    .goldGain { position: absolute; color: yellow; font-size: 18px; opacity: 1; animation: floatUp 1s ease-out forwards; }
    @keyframes floatUp { from { transform: translateY(0); opacity:1;} to { transform: translateY(-30px); opacity:0;} }

    /* 敵 */
    #enemy { width: 200px; height: 200px; background: white; position: absolute; top: 30%; left:50%; transform:translateX(-50%); cursor:pointer; }

    /* HPバー */
    #enemyHpContainer { width: 220px; height: 25px; background: #666; position: absolute; top: 25%; left:50%; transform:translateX(-50%); border-radius:5px; overflow:hidden; }
    #enemyHp { height: 100%; width:100%; background: green; transition: width 0.2s linear, background 0.2s linear; }
    #enemyHpText { position:absolute; top:25%; left:50%; transform:translate(-50%, -120%); font-size:16px; color:white; background:transparent; }

    /* Expバー */
    #expContainer { width: 400px; height: 20px; background:#666; position:absolute; bottom:40px; left:50%; transform:translateX(-50%); border-radius:5px; overflow:hidden; }
    #expBar { height:100%; width:0%; background:white; transition: width 0.2s linear; }

    /* Level表示 */
    #level { position:absolute; bottom:70px; left:50%; transform:translateX(-50%); font-size:20px; }

    /* アップグレードボタン */
    #upgradeBtn { position:absolute; right:20px; top:50%; transform:translateY(-50%); padding:10px 20px; background:#444; color:white; border:none; cursor:pointer; font-size:18px; border-radius:10px; }

    /* アップグレード画面 */
    #upgradeMenu { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40%; height:65%; background:#333; border:2px solid white; border-radius:15px; padding:20px; text-align:center; }
    #upgradeMenu h2 { margin:10px 0; }
    .upgradeBtn { display:block; margin:10px auto; padding:10px; width:80%; font-size:18px; background:#555; border:none; color:white; border-radius:8px; cursor:pointer; }
    .upgradeBtn:disabled { background:#222; cursor:not-allowed; }
    #closeUpgrade { margin-top:15px; padding:8px 16px; background:#900; border:none; color:white; font-size:16px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div id="gold">Gold: 0</div>
  <div id="enemyHpContainer"><div id="enemyHp"></div></div>
  <div id="enemyHpText">100 / 100</div>
  <div id="enemy"></div>
  <div id="level">Level: 1</div>
  <div id="expContainer"><div id="expBar"></div></div>

  <button id="upgradeBtn">アップグレード</button>

  <div id="upgradeMenu">
    <h2>アップグレード</h2>
    <p id="upgradePoints">ポイント: 0</p>
    <button id="autoAttackBtn" class="upgradeBtn">自動攻撃 (最大1)</button>
    <button id="attackPowerBtn" class="upgradeBtn">攻撃力アップ</button>
    <button id="attackSpeedBtn" class="upgradeBtn">自動攻撃速度アップ</button>
    <button id="goldBoostBtn" class="upgradeBtn">ゴールド増加 (最大5)</button>
    <button id="closeUpgrade">閉じる</button>
  </div>

  <script>
    let gold = 0, exp = 0, level = 1, maxLevel = 200;
    let enemyMaxHp = 100, enemyHp = enemyMaxHp;
    let attackDamage = 10, goldMultiplier = 1;
    let autoAttack = false, upgradePoints = 0;
    let autoAttackInterval = 3000, autoAttackTimer = null;

    let upgrades = { autoAttack:0, attackPower:0, goldBoost:0, attackSpeed:0 };

    const goldEl = document.getElementById("gold");
    const enemyEl = document.getElementById("enemy");
    const enemyHpEl = document.getElementById("enemyHp");
    const enemyHpTextEl = document.getElementById("enemyHpText");
    const expBarEl = document.getElementById("expBar");
    const levelEl = document.getElementById("level");
    const upgradeBtn = document.getElementById("upgradeBtn");
    const upgradeMenu = document.getElementById("upgradeMenu");
    const upgradePointsEl = document.getElementById("upgradePoints");
    const autoAttackBtn = document.getElementById("autoAttackBtn");
    const attackPowerBtn = document.getElementById("attackPowerBtn");
    const goldBoostBtn = document.getElementById("goldBoostBtn");
    const attackSpeedBtn = document.getElementById("attackSpeedBtn");
    const closeUpgradeBtn = document.getElementById("closeUpgrade");

    function requiredExp(lv){ return lv*10; }

    function updateEnemyHp(){
      let percent = (enemyHp/enemyMaxHp)*100;
      enemyHpEl.style.width = percent+"%";
      enemyHpEl.style.background = percent>50?"green":percent>20?"yellow":"red";
      enemyHpTextEl.textContent = enemyHp+" / "+enemyMaxHp;
    }

    function updateExp(){
      let percent = Math.min((exp/requiredExp(level))*100,100);
      expBarEl.style.width = percent+"%";
      levelEl.textContent = "Level: "+level;
    }

    function updateGold(){ goldEl.textContent = "Gold: "+gold; }
    function updateUpgradePoints(){ upgradePointsEl.textContent = "ポイント: "+upgradePoints; }

    function showGoldGain(amount){
      const gain = document.createElement("div");
      gain.className = "goldGain"; gain.textContent = "+"+amount;
      gain.style.left = "55%"; gain.style.top = "40px";
      document.body.appendChild(gain);
      setTimeout(()=>gain.remove(),1000);
    }

    function getEnemyMaxHp(){ return 100 + Math.floor(level/5)*100; }

    function attackEnemy(){
      enemyHp -= attackDamage;
      if(enemyHp<=0){
        let rewardGold = 5*goldMultiplier; gold+=rewardGold; exp+=2;
        showGoldGain(rewardGold);
        updateGold(); updateExp();
        while(exp>=requiredExp(level) && level<maxLevel){
          exp -= requiredExp(level);
          level++; upgradePoints++;
          updateExp(); updateUpgradePoints();
        }
        enemyMaxHp = getEnemyMaxHp(); enemyHp = enemyMaxHp;
      }
      updateEnemyHp(); saveData();
    }

    // クリック攻撃
    enemyEl.addEventListener("click", attackEnemy);

    // コスト計算
    function attackPowerCost(lv){ if(lv<=2)return 1; if(lv<=4)return 3; if(lv<=7)return 5; return 15; }
    function attackSpeedCost(lv){ return [10,10,25,50,75][lv]||100; }

    // アップグレード処理
    autoAttackBtn.addEventListener("click",()=>{
      if(upgradePoints>0 && upgrades.autoAttack<1){
        upgrades.autoAttack++; upgradePoints--; autoAttack=true;
        autoAttackInterval=3000; autoAttackTimer=setInterval(attackEnemy,autoAttackInterval);
        autoAttackBtn.disabled=true; updateUpgradePoints(); saveData();
      }
    });

    attackPowerBtn.addEventListener("click",()=>{
      let cost = attackPowerCost(upgrades.attackPower+1);
      if(upgradePoints>=cost && upgrades.attackPower<10){
        upgradePoints-=cost; upgrades.attackPower++;
        attackDamage *= 2;
        if(upgrades.attackPower===10) attackPowerBtn.disabled=true;
        updateUpgradePoints(); saveData();
      }
    });

    attackSpeedBtn.addEventListener("click",()=>{
      if(upgrades.autoAttack===0){ alert("まず自動攻撃を購入してください"); return; }
      let cost = attackSpeedCost(upgrades.attackSpeed);
      if(upgradePoints>=cost && upgrades.attackSpeed<5){
        upgradePoints-=cost; upgrades.attackSpeed++;
        autoAttackInterval = [2500,2000,1000,500,200][upgrades.attackSpeed-1];
        if(autoAttackTimer) clearInterval(autoAttackTimer);
        autoAttackTimer=setInterval(attackEnemy,autoAttackInterval);
        if(upgrades.attackSpeed===5) attackSpeedBtn.disabled=true;
        updateUpgradePoints(); saveData();
      }
    });

    goldBoostBtn.addEventListener("click",()=>{
      if(upgradePoints>0 && upgrades.goldBoost<5){
        upgradePoints--; upgrades.goldBoost++;
        goldMultiplier = upgrades.goldBoost+1;
        if(upgrades.goldBoost===5) goldBoostBtn.disabled=true;
        updateUpgradePoints(); saveData();
      }
    });

    upgradeBtn.addEventListener("click",()=>{ upgradeMenu.style.display="block"; });
    closeUpgradeBtn.addEventListener("click",()=>{ upgradeMenu.style.display="none"; });

    // 保存＆読み込み
    function saveData(){
      localStorage.setItem("rpgData",JSON.stringify({gold,exp,level,upgradePoints,upgrades,attackDamage,goldMultiplier,autoAttack,autoAttackInterval}));
    }
    function loadData(){
      let data = JSON.parse(localStorage.getItem("rpgData"));
      if(data){
        gold=data.gold; exp=data.exp; level=data.level; upgradePoints=data.upgradePoints;
        upgrades=data.upgrades; attackDamage=data.attackDamage; goldMultiplier=data.goldMultiplier;
        autoAttack=data.autoAttack; autoAttackInterval=data.autoAttackInterval||3000;
        if(autoAttack && upgrades.autoAttack===1) autoAttackTimer=setInterval(attackEnemy,autoAttackInterval);
        if(upgrades.autoAttack===1) autoAttackBtn.disabled=true;
        if(upgrades.attackPower===10) attackPowerBtn.disabled=true;
        if(upgrades.attackSpeed===5) attackSpeedBtn.disabled=true;
        if(upgrades.goldBoost===5) goldBoostBtn.disabled=true;
      }
      enemyMaxHp=getEnemyMaxHp(); enemyHp=enemyMaxHp;
      updateGold(); updateExp(); updateEnemyHp(); updateUpgradePoints();
    }

    loadData();
  </script>
</body>
</html>
